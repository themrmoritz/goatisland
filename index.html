<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goat Island Pro</title>
    <style>
        :root {
            --bg: #f0f4f8;
            --surface: #ffffff;
            --primary: #3182ce;
            --text: #2d3748;
            --subtext: #718096;
            --good: #48bb78;
            --ok: #ecc94b;
            --bad: #f56565;
            --radius: 16px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container { max-width: 600px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 30px; }
        h1 { margin: 0; color: #2c5282; letter-spacing: -0.5px; }
        .subtitle { color: var(--subtext); font-size: 0.9rem; margin-top: 5px; }

        /* RELIABILITY BAR */
        .confidence-meter {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            margin-top: 10px;
            overflow: hidden;
            width: 100px;
            margin: 10px auto 0 auto;
        }
        .confidence-fill { height: 100%; transition: width 0.3s ease, background-color 0.3s ease; }

        /* CARDS */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            border: 1px solid rgba(0,0,0,0.04);
            transition: transform 0.2s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            border-bottom: 1px solid #edf2f7;
            padding-bottom: 12px;
        }

        .date-group h2 { margin: 0; font-size: 1.25rem; }
        .date-group span { font-size: 0.85rem; color: var(--subtext); font-weight: 500; }

        /* SCORE INDICATOR */
        .score-badge {
            font-size: 1.2rem;
            font-weight: 800;
            color: white;
            padding: 8px 16px;
            border-radius: 12px;
            text-align: center;
            min-width: 60px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* GRID METRICS */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .metric {
            background: #f7fafc;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        .metric-label { font-size: 0.75rem; color: var(--subtext); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 4px; }
        .metric-value { font-size: 1.1rem; font-weight: 700; color: var(--text); }
        .metric-sub { font-size: 0.75rem; color: var(--subtext); }

        /* BEST WINDOW SECTION */
        .best-window {
            background: #ebf8ff;
            color: #2b6cb0;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .window-icon { font-size: 1.2rem; }

        /* TIDE BUTTON */
        .tide-btn {
            display: block;
            width: 100%;
            text-align: center;
            background: white;
            border: 1px solid #cbd5e0;
            color: #4a5568;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9rem;
            text-decoration: none;
            margin-top: 15px;
            font-weight: 500;
        }
        .tide-btn:hover { background: #f7fafc; }

        /* LOADING & ERROR */
        #loading { text-align: center; padding: 40px; color: var(--subtext); }
        .hidden { display: none; }
        .error-box { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; font-size: 0.9em; }

        /* COLOR UTILITIES */
        .bg-good { background-color: var(--good); }
        .bg-ok { background-color: var(--ok); color: #744210; }
        .bg-bad { background-color: var(--bad); }
        
        .warning-text { color: #e53e3e; font-size: 0.8rem; font-weight: bold; margin-top: 5px; display: block; }

    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ü§ø Goat Island Pro</h1>
        <div class="subtitle">7-Day Snorkel Forecaster</div>
    </header>

    <div id="debug-area"></div>
    <div id="loading">Scanning satellites...</div>
    <div id="app"></div>
</div>

<script>
    // --- 1. CRASH REPORTER (Debug Tool) ---
    // This catches any error and prints it to the screen so you can see it on mobile/GitHub
    window.onerror = function(message, source, lineno, colno, error) {
        const debug = document.getElementById('debug-area');
        debug.innerHTML = `
            <div class="error-box">
                <strong>‚ö†Ô∏è App Crash Detected:</strong><br/>
                ${message}<br/>
                <small>Line: ${lineno}</small>
            </div>
        `;
        document.getElementById('loading').classList.add('hidden');
    };

    // --- 2. CONFIGURATION ---
    const CONFIG = {
        lat: -36.27, // Goat Island Marine Reserve
        lon: 174.80,
        timezone: "Pacific/Auckland",
        onshoreWinds: ['N', 'NE', 'NW'], 
        offshoreWinds: ['S', 'SW', 'SE'],
        maxSwell: 1.0, 
    };

    // --- 3. HELPER FUNCTIONS ---
    function getCardinal(angle) {
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        return directions[Math.round(angle / 45) % 8];
    }

    function getConfidence(daysAway) {
        const score = Math.max(20, 100 - (daysAway * 12)); 
        let color = '#48bb78'; 
        if(score < 75) color = '#ecc94b'; 
        if(score < 50) color = '#cbd5e0'; 
        return { score, color };
    }

    function findBestWindow(hourlyData, dayIndex) {
        // Safety check
        if (!hourlyData || !hourlyData.wave_height) return "Daylight Hours";

        const start = dayIndex * 24;
        let bestHour = -1;
        let minScore = 999;

        // Check daylight hours (7am - 7pm)
        for(let i = start + 7; i < start + 19; i++) {
            // Ensure data exists for this hour
            if (hourlyData.wave_height[i] === undefined) continue;
            
            const swell = hourlyData.wave_height[i];
            const wind = hourlyData.wind_speed[i];
            const score = (swell * 10) + wind; 

            if(score < minScore) {
                minScore = score;
                bestHour = i % 24; 
            }
        }
        
        if (bestHour === -1) return "Daylight Hours";

        const endHour = bestHour + 3;
        return `${bestHour}:00 - ${endHour}:00`;
    }

    // --- 4. CORE LOGIC ---
    function analyzeDay(dayData, hourlyData, index) {
        let score = 10; 
        let warnings = [];

        // Critical Safety Check: Do we have data for this day?
        if (!dayData.wave_height_max || dayData.wave_height_max[index] === undefined) {
            return null;
        }

        const swell = dayData.wave_height_max[index];
        const windSpeed = dayData.wind_speed_10m_max[index];
        const windDirDeg = dayData.wind_direction_10m_dominant[index];
        const windDir = getCardinal(windDirDeg);

        // Penalties
        if (swell > 0.8) score -= 2;
        if (swell > 1.2) score -= 4;
        if (swell > 1.5) { score -= 10; warnings.push("Dangerous Swell"); } 

        if (windSpeed > 10) score -= 1;
        if (windSpeed > 15) score -= 3;
        if (windSpeed > 20) { score -= 5; warnings.push("High Winds"); }

        if (CONFIG.onshoreWinds.includes(windDir)) {
            score -= 3;
            warnings.push("Onshore Wind");
        } else if (CONFIG.offshoreWinds.includes(windDir)) {
            score += 1; 
        }

        score = Math.max(0, Math.min(10, score));

        let state = { text: "GREAT", class: "bg-good" };
        if (score < 7) state = { text: "OKAY", class: "bg-ok" };
        if (score < 4) state = { text: "POOR", class: "bg-bad" };

        return {
            score: Math.floor(score),
            verdict: state.text,
            cssClass: state.class,
            swell: swell.toFixed(1),
            windSpeed: Math.round(windSpeed),
            windDir: windDir,
            warnings: warnings,
            bestWindow: findBestWindow(hourlyData, index)
        };
    }

    // --- 5. INITIALIZATION ---
    async function init() {
        const loadingDiv = document.getElementById('loading');
        const debugDiv = document.getElementById('debug-area');
        
        // Open-Meteo URL (using HTTPS)
        const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${CONFIG.lat}&longitude=${CONFIG.lon}&current=wave_height,wind_wave_height,swell_wave_height&hourly=wave_height,wind_speed_10m&daily=wave_height_max,wind_speed_10m_max,wind_direction_10m_dominant&wind_speed_unit=kn&timezone=${encodeURIComponent(CONFIG.timezone)}`;

        try {
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`API Status: ${response.status}`);
            }

            const data = await response.json();
            
            if (!data.daily) {
                throw new Error("Weather data missing from API response");
            }

            render(data);
        } catch (e) {
            loadingDiv.classList.add('hidden');
            debugDiv.innerHTML = `
                <div class="error-box">
                    <strong>‚ö†Ô∏è Data Connection Failed</strong><br/>
                    ${e.message}<br/>
                    <small>Try turning off ad-blockers or refreshing.</small>
                </div>
            `;
        }
    }

    // --- 6. RENDER UI ---
    function render(data) {
        const container = document.getElementById('app');
        document.getElementById('loading').classList.add('hidden');
        
        const daily = data.daily;
        const hourly = data.hourly; 

        if (daily.time.length === 0) {
            container.innerHTML = "<p>No forecast data available.</p>";
            return;
        }

        daily.time.forEach((dateStr, i) => {
            const date = new Date(dateStr);
            const dateDisplay = date.toLocaleDateString('en-NZ', { weekday: 'long', day: 'numeric', month: 'short' });
            
            const analysis = analyzeDay(daily, hourly, i);
            
            // If data is corrupt for one day, skip it rather than crashing
            if (!analysis) return;

            const confidence = getConfidence(i);

            const card = document.createElement('div');
            card.className = 'card';
            
            const warningHTML = analysis.warnings.length > 0 
                ? `<span class="warning-text">‚ö†Ô∏è ${analysis.warnings[0]}</span>` 
                : '';

            card.innerHTML = `
                <div class="card-header">
                    <div class="date-group">
                        <h2>${dateDisplay}</h2>
                        <div class="confidence-meter" title="Forecast Confidence">
                            <div class="confidence-fill" style="width: ${confidence.score}%; background: ${confidence.color}"></div>
                        </div>
                    </div>
                    <div class="score-badge ${analysis.cssClass}">
                        ${analysis.score}/10
                        <div style="font-size:0.6rem; font-weight:normal; text-transform:uppercase; margin-top:2px; opacity:0.9">${analysis.verdict}</div>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric">
                        <span class="metric-label">Swell Height</span>
                        <div class="metric-value">${analysis.swell}m</div>
                        <div class="metric-sub">Target: &lt;1.0m</div>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Wind</span>
                        <div class="metric-value">${analysis.windSpeed} <span style="font-size:0.7em">knots</span></div>
                        <div class="metric-sub">${analysis.windDir} (${CONFIG.offshoreWinds.includes(analysis.windDir) ? 'Offshore' : 'Direction'})</div>
                        ${warningHTML}
                    </div>
                </div>

                <div class="best-window">
                    <span class="window-icon">üïí</span>
                    <div>
                        <strong>Best Window:</strong> ${analysis.bestWindow}<br>
                        <span style="font-size:0.8em; opacity:0.8">Calculated for lowest wind/swell</span>
                    </div>
                </div>

                <a href="https://www.metservice.com/marine/recreational/locations/leigh-marine-reserve" target="_blank" class="tide-btn">
                    üåä Check Tides (MetService)
                </a>
            `;

            container.appendChild(card);
        });
    }

    // Start App
    init();
</script>
</body>
</html>
